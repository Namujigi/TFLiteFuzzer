# -*- coding: utf-8 -*-
"""tflite_convert.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/17EX4VhXVp-SXvwjSnqCogbtzr0ESr79G

# TensorFlow ëª¨ë¸ ë° ë°ì´í„°ì…‹ ë‹¤ìš´ë¡œë“œ
### 1. Kerasì˜ fine-tuned ëª¨ë¸ì„ Hugging Faceë¡œë¶€í„° ë‹¤ìš´ë¡œë“œ

### 2. cifar-10 ê³µê°œ ë°ì´í„°ì…‹ì„ Hugging Faceë¡œë¶€í„° ë‹¤ìš´ë¡œë“œ
"""

!pip install -q huggingface_hub
!pip install pynvml

import os
import numpy as np
import tensorflow as tf
from tensorflow import keras
from huggingface_hub import from_pretrained_keras
import psutil
import time
import matplotlib.pyplot as plt
from pathlib import Path
from IPython.display import display, HTML, clear_output
import warnings
warnings.filterwarnings('ignore')

print("âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸ ì™„ë£Œ!")
print(f"ğŸ“Œ TensorFlow ë²„ì „: {tf.__version__}")

# GPU í™•ì¸
gpus = tf.config.list_physical_devices('GPU')
if gpus:
    print(f"ğŸ® GPU ì‚¬ìš© ê°€ëŠ¥: {len(gpus)}ê°œ")
    for gpu in gpus:
        tf.config.experimental.set_memory_growth(gpu, True)
        print(f"   - {gpu.name}")
else:
    print("ğŸ’» CPU ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤")

# pynvmlì€ NVIDIA GPUë§Œ ì§€ì›í•©ë‹ˆë‹¤. Colab T4 GPUì—ì„œ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.
try:
    import pynvml
    pynvml.nvmlInit()
    NVIDIA_GPU_AVAILABLE = True
except (ImportError, pynvml.NVMLError):
    NVIDIA_GPU_AVAILABLE = False
    print("NVIDIA GPU ë˜ëŠ” pynvml ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

class ResourceMonitor:
    """ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ í´ë˜ìŠ¤"""
    def __init__(self):
        self.process = psutil.Process()
        self.has_gpu = len(tf.config.list_physical_devices('GPU')) > 0

    def get_stats(self):
        cpu_percent = self.process.cpu_percent(interval=0.1)
        memory_mb = self.process.memory_info().rss / 1024 / 1024

        gpu_memory = 0
        if self.has_gpu:
            try:
                gpu_memory = tf.config.experimental.get_memory_info('GPU:0')['current'] / 1024 / 1024
            except:
                pass

        return {
            'cpu_percent': cpu_percent,
            'memory_mb': memory_mb,
            'gpu_memory_mb': gpu_memory
        }

def print_section(title, emoji="ğŸ“Œ"):
    """ì„¹ì…˜ ì œëª© ì¶œë ¥"""
    print("\n" + "="*80)
    print(f"{emoji} {title}")
    print("="*80)

def get_model_size(model_path):
    """ëª¨ë¸ íŒŒì¼ í¬ê¸° ê³„ì‚° (MB)"""
    if os.path.isfile(model_path):
        return os.path.getsize(model_path) / (1024 * 1024)
    elif os.path.isdir(model_path):
        total_size = 0
        for dirpath, dirnames, filenames in os.walk(model_path):
            for filename in filenames:
                filepath = os.path.join(dirpath, filename)
                total_size += os.path.getsize(filepath)
        return total_size / (1024 * 1024)
    return 0

print("âœ… ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì •ì˜ ì™„ë£Œ!")

# ============================================================================
# âš™ï¸  ê°œì„ ëœ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„° í´ë˜ìŠ¤
# ============================================================================

class AdvancedResourceMonitor:
    """
    psutilê³¼ pynvmlì„ ì‚¬ìš©í•˜ì—¬ CPU, GPU, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ë³´ë‹¤ ì •í™•í•˜ê²Œ ì¸¡ì •í•˜ëŠ” í´ë˜ìŠ¤.
    """
    def __init__(self):
        self.process = psutil.Process()
        self.cpu_cores = psutil.cpu_count(logical=True)
        self.start_stats = {}

        self.gpu_handle = None
        if NVIDIA_GPU_AVAILABLE and pynvml.nvmlDeviceGetCount() > 0:
            self.gpu_handle = pynvml.nvmlDeviceGetHandleByIndex(0)
        else:
            self.gpu_handle = None

    def start(self):
        """ì¸¡ì • ì‹œì‘ì  ê¸°ë¡"""
        self.process.cpu_percent(interval=None)
        self.start_stats['time'] = time.time()

    def stop(self):
        """ì¸¡ì • ì¢…ë£Œ ë° ê²°ê³¼ ê³„ì‚°"""
        end_time = time.time()

        cpu_percent = self.process.cpu_percent(interval=None) / self.cpu_cores
        memory_mb = self.process.memory_info().rss / 1024 / 1024

        gpu_util = 0
        gpu_memory_mb = 0
        if self.gpu_handle:
            try:
                gpu_info = pynvml.nvmlDeviceGetUtilizationRates(self.gpu_handle)
                gpu_util = gpu_info.gpu
                mem_info = pynvml.nvmlDeviceGetMemoryInfo(self.gpu_handle)
                gpu_memory_mb = mem_info.used / 1024 / 1024
            except pynvml.NVMLError:
                # Colabì—ì„œ ê°„í—ì ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ ë°©ì§€
                pass

        return {
            'inference_time_sec': end_time - self.start_stats['time'],
            'avg_cpu_percent': cpu_percent,
            'ram_mb': memory_mb,
            'avg_gpu_util_percent': gpu_util,
            'gpu_ram_mb': gpu_memory_mb
        }

def print_results(stats, num_images):
    """ì¸¡ì • ê²°ê³¼ ì¶œë ¥ í•¨ìˆ˜"""
    total_time = stats['inference_time_sec']
    avg_time_ms = total_time / num_images * 1000

    print(f"â±ï¸  ì´ ì¶”ë¡  ì‹œê°„:         {total_time:.3f}ì´ˆ")
    print(f"âš¡ ì´ë¯¸ì§€ë‹¹ í‰ê·  ì‹œê°„:    {avg_time_ms:.2f}ms")
    print(f"ğŸ’» í‰ê·  CPU ì‚¬ìš©ë¥ :       {stats['avg_cpu_percent']:.1f}%")
    print(f"ğŸ§  í”„ë¡œì„¸ìŠ¤ RAM ì‚¬ìš©ëŸ‰:   {stats['ram_mb']:.1f}MB")
    if NVIDIA_GPU_AVAILABLE:
        print(f"ğŸ® í‰ê·  GPU ì‚¬ìš©ë¥ :       {stats['avg_gpu_util_percent']:.1f}%")
        print(f"ğŸ“Š GPU ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:    {stats['gpu_ram_mb']:.1f}MB")
    print("="*50)

# ============================================================================
# ğŸ“Š 3. CIFAR-10 ë°ì´í„°ì…‹ ë¡œë“œ
# ============================================================================

print_section("CIFAR-10 ë°ì´í„°ì…‹ ë¡œë“œ", "ğŸ“Š")

# CIFAR-10 í´ë˜ìŠ¤ ì´ë¦„
class_names = ['airplane', 'automobile', 'bird', 'cat', 'deer',
               'dog', 'frog', 'horse', 'ship', 'truck']

# CIFAR-10 ë°ì´í„°ì…‹ ë¡œë“œ
print("â³ CIFAR-10 ë°ì´í„°ì…‹ ë‹¤ìš´ë¡œë“œ ì¤‘...")
(x_train, y_train), (x_test, y_test) = keras.datasets.cifar10.load_data()

print(f"\nâœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!")
print(f"   ğŸ“¦ í•™ìŠµ ë°ì´í„°: {x_train.shape}")
print(f"   ğŸ“¦ í…ŒìŠ¤íŠ¸ ë°ì´í„°: {x_test.shape}")
print(f"   ğŸ“ ì´ë¯¸ì§€ í¬ê¸°: 32x32x3 (RGB)")
print(f"   ğŸ·ï¸ í´ë˜ìŠ¤ ìˆ˜: {len(class_names)}ê°œ")

# í´ë˜ìŠ¤ë³„ ìƒ˜í”Œ ìˆ˜ í™•ì¸
unique, counts = np.unique(y_test, return_counts=True)
print(f"\nğŸ“Š í…ŒìŠ¤íŠ¸ ë°ì´í„° í´ë˜ìŠ¤ ë¶„í¬:")
for cls, count in zip(unique, counts):
    print(f"   {class_names[cls]}: {count}ê°œ")

# # ìƒ˜í”Œ ì´ë¯¸ì§€ ì‹œê°í™”
# print("\nğŸ–¼ï¸ ìƒ˜í”Œ ì´ë¯¸ì§€:")
# fig, axes = plt.subplots(2, 5, figsize=(15, 6))
# axes = axes.ravel()

# for idx in range(10):
#     axes[idx].imshow(x_test[idx])
#     axes[idx].set_title(f"{class_names[y_test[idx][0]]}", fontsize=12, fontweight='bold')
#     axes[idx].axis('off')

# plt.tight_layout()
# plt.show()

# ============================================================================
# ğŸ¤– 4. ì‚¬ì „í•™ìŠµëœ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ
# ============================================================================

print_section("ì‚¬ì „í•™ìŠµëœ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ", "ğŸ¤–")

print("â³ Hugging Faceì—ì„œ keras-io/supervised-contrastive-learning-cifar10 ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘...")
print("   (ResNet50V2 ê¸°ë°˜, Supervised Contrastive Learningìœ¼ë¡œ í•™ìŠµ)")

try:
    model = from_pretrained_keras("keras-io/supervised-contrastive-learning-cifar10")
    print("\nâœ… ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ë° ë¡œë“œ ì™„ë£Œ!")
except Exception as e:
    print(f"\nâŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: {e}")
    raise

# ëª¨ë¸ ì •ë³´ ì¶œë ¥
print(f"\nğŸ“‹ ëª¨ë¸ ì •ë³´:")
print(f"   ğŸ—ï¸ ì•„í‚¤í…ì²˜: ResNet50V2 + Supervised Contrastive Learning")
print(f"   ğŸ”¢ ì´ íŒŒë¼ë¯¸í„°: {model.count_params():,}")
print(f"   ğŸ“ ì…ë ¥ shape: {model.input_shape}")
print(f"   ğŸ“¤ ì¶œë ¥ shape: {model.output_shape}")

# ëª¨ë¸ êµ¬ì¡° ì¶œë ¥
print("\nğŸ“‹ ëª¨ë¸ êµ¬ì¡°:")
model.summary()

# ëª¨ë¸ ì €ì¥
model_path = 'cifar10_contrastive_model'
model.save(model_path)
keras_size = get_model_size(model_path)
print(f"\nğŸ’¾ Keras ëª¨ë¸ ì €ì¥ ì™„ë£Œ: {model_path}")
print(f"   ğŸ“¦ ëª¨ë¸ í¬ê¸°: {keras_size:.2f} MB")

# ============================================================================
# ğŸ”§ 5. ë°ì´í„° ì „ì²˜ë¦¬
# ============================================================================

print_section("ë°ì´í„° ì „ì²˜ë¦¬", "ğŸ”§")

# CIFAR-10 ë°ì´í„° ì „ì²˜ë¦¬ (ì •ê·œí™”)
print("â³ ë°ì´í„° ì •ê·œí™” ì¤‘...")
x_test_normalized = x_test.astype('float32')

print(f"\nâœ… ì „ì²˜ë¦¬ ì™„ë£Œ!")
print(f"   ğŸ“ í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ shape: {x_test_normalized.shape}")
print(f"   ğŸ“Š ì›ë³¸ ë°ì´í„° ë²”ìœ„: [{x_test.min()}, {x_test.max()}]")
print(f"   ğŸ“Š ì „ì²˜ë¦¬ ë°ì´í„° ë²”ìœ„: [{x_test_normalized.min():.2f}, {x_test_normalized.max():.2f}]")

# ì „ì²˜ë¦¬ëœ ìƒ˜í”Œ ì´ë¯¸ì§€ í™•ì¸
print("\nğŸ–¼ï¸ ì „ì²˜ë¦¬ëœ ìƒ˜í”Œ ì´ë¯¸ì§€ (10ê°œ í´ë˜ìŠ¤):")
fig, axes = plt.subplots(2, 5, figsize=(15, 6))
axes = axes.ravel()

# ê° í´ë˜ìŠ¤ë³„ë¡œ í•˜ë‚˜ì”© ìƒ˜í”Œ í‘œì‹œ
for cls_idx in range(10):
    # í•´ë‹¹ í´ë˜ìŠ¤ì˜ ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ì°¾ê¸°
    sample_idx = np.where(y_test == cls_idx)[0][0]

    # ì •ê·œí™”ëœ ì´ë¯¸ì§€ë¥¼ ì›ë³¸ ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜í•˜ì—¬ ì‹œê°í™”
    display_img = x_test_normalized[sample_idx] / 255.0

    axes[cls_idx].imshow(display_img)
    axes[cls_idx].set_title(f"{class_names[cls_idx]}", fontsize=12, fontweight='bold')
    axes[cls_idx].axis('off')

plt.tight_layout()
plt.show()

# ============================================================================
# ğŸ§ª 6. Keras ëª¨ë¸ í…ŒìŠ¤íŠ¸
# ============================================================================

print_section("Keras ëª¨ë¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸", "ğŸ§ª")

monitor = AdvancedResourceMonitor()

# ì›Œë°ì—…
print("â³ ì›Œë°ì—… ì¤‘...")
_ = model.predict(x_test_normalized[:10], verbose=0)

# í…ŒìŠ¤íŠ¸ ì‹œì‘
print("â³ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘... (10,000ê°œ ì´ë¯¸ì§€)")
# start_stats = monitor.get_stats()

if len(tf.config.list_physical_devices('GPU')) > 0:
    with tf.device('/GPU:0'):
        start_time = time.time()
        monitor.start()
        predictions = model.predict(x_test_normalized, batch_size=128, verbose=1)
        end_time = time.time()
        results = monitor.stop()
else:
    print("GPUë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.")

# end_time = time.time()
# end_stats = monitor.get_stats()

# ê²°ê³¼ ê³„ì‚°
predicted_labels = np.argmax(predictions, axis=1)
true_labels = y_test.flatten()
accuracy = np.mean(predicted_labels == true_labels)
inference_time = end_time - start_time
avg_time_per_image = inference_time / len(x_test_normalized) * 1000

# # í´ë˜ìŠ¤ë³„ ì •í™•ë„ ê³„ì‚°
# print("\nğŸ“Š í´ë˜ìŠ¤ë³„ ì •í™•ë„:")
# for cls_idx in range(10):
#     cls_mask = true_labels == cls_idx
#     cls_accuracy = np.mean(predicted_labels[cls_mask] == true_labels[cls_mask])
#     print(f"   {class_names[cls_idx]:<12}: {cls_accuracy * 100:.2f}%")

# # í˜¼ë™ í–‰ë ¬ ê³„ì‚°
# from sklearn.metrics import confusion_matrix
# cm = confusion_matrix(true_labels, predicted_labels)

print("\nâœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
print(f"\n{'='*50}")
print(f"ğŸ“Š Keras ëª¨ë¸ ì„±ëŠ¥ ê²°ê³¼")
print(f"{'='*50}")
print(f"ğŸ¯ ì „ì²´ ì •í™•ë„:         {accuracy * 100:.2f}%")
print(f"â±ï¸  ì´ ì¶”ë¡  ì‹œê°„:         {inference_time:.3f}ì´ˆ")
# print(f"âš¡ ì´ë¯¸ì§€ë‹¹ í‰ê·  ì‹œê°„:    {avg_time_per_image:.2f}ms")
# print(f"ğŸ’» CPU ì‚¬ìš©ëŸ‰:           {end_stats['cpu_percent']:.1f}%")
# print(f"ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:        {end_stats['memory_mb']:.1f}MB")
# if monitor.has_gpu:
#     print(f"ğŸ® GPU ë©”ëª¨ë¦¬:           {end_stats['gpu_memory_mb']:.1f}MB")
# print(f"{'='*50}")
print_results(results, len(x_test_normalized))

keras_results = {
    'accuracy': accuracy,
    'inference_time': inference_time,
    'avg_time_per_image': avg_time_per_image,
    'cpu_percent': results['avg_cpu_percent'],
    'memory_mb': results['ram_mb'],
    'avg_gpu_util_percent': results['avg_gpu_util_percent'],
    'gpu_memory_mb': results['gpu_ram_mb'],
    'size_mb': keras_size
}

# # ì˜ˆì¸¡ ê²°ê³¼ ì‹œê°í™”
# print("\nğŸ–¼ï¸ ì˜ˆì¸¡ ê²°ê³¼ ìƒ˜í”Œ (ì •ë‹µ/ì˜¤ë‹µ í¬í•¨):")
# fig, axes = plt.subplots(3, 5, figsize=(18, 11))
# axes = axes.ravel()

# # ì •ë‹µê³¼ ì˜¤ë‹µ ìƒ˜í”Œ ìˆ˜ì§‘
# correct_indices = np.where(predicted_labels == true_labels)[0]
# incorrect_indices = np.where(predicted_labels != true_labels)[0]

# # 10ê°œ ì •ë‹µ, 5ê°œ ì˜¤ë‹µ ìƒ˜í”Œ í‘œì‹œ
# sample_indices = list(correct_indices[:10]) + list(incorrect_indices[:5])

# for idx, sample_idx in enumerate(sample_indices):
#     true_label = class_names[true_labels[sample_idx]]
#     pred_label = class_names[predicted_labels[sample_idx]]
#     confidence = predictions[sample_idx][predicted_labels[sample_idx]] * 100

#     color = 'green' if predicted_labels[sample_idx] == true_labels[sample_idx] else 'red'

#     axes[idx].imshow(x_test[sample_idx])
#     axes[idx].set_title(
#         f"ì‹¤ì œ: {true_label}\nì˜ˆì¸¡: {pred_label} ({confidence:.1f}%)",
#         fontsize=11, fontweight='bold', color=color
#     )
#     axes[idx].axis('off')

# plt.tight_layout()
# plt.show()

"""# TFLite ë³€í™˜ (Keras Model â†’ .tflite Model)"""

# ============================================================================
# ğŸ”„ 7. TFLite ë³€í™˜
# ============================================================================

print_section("TFLite ëª¨ë¸ ë³€í™˜", "ğŸ”„")

print("â³ TFLite ë³€í™˜ ì¤‘...")

# TFLite ì»¨ë²„í„° ì„¤ì •
converter = tf.lite.TFLiteConverter.from_keras_model(model)
converter.optimizations = [tf.lite.Optimize.DEFAULT]

# Representative dataset for quantization
def representative_dataset():
    for i in range(min(100, len(x_test_normalized))):
        yield [x_test_normalized[i:i+1]]

converter.representative_dataset = representative_dataset
converter.target_spec.supported_ops = [tf.lite.OpsSet.TFLITE_BUILTINS]

# ë³€í™˜ ìˆ˜í–‰
try:
    tflite_model = converter.convert()
    print("âœ… ì–‘ìí™” ë³€í™˜ ì„±ê³µ!")
except Exception as e:
    print(f"âš ï¸ ì–‘ìí™” ë³€í™˜ ì‹¤íŒ¨: {e}")
    print("   ê¸°ë³¸ ë³€í™˜ìœ¼ë¡œ ì¬ì‹œë„...")
    converter = tf.lite.TFLiteConverter.from_keras_model(model)
    tflite_model = converter.convert()
    print("âœ… ê¸°ë³¸ ë³€í™˜ ì„±ê³µ!")

# TFLite ëª¨ë¸ ì €ì¥
tflite_path = 'cifar10_model.tflite'
with open(tflite_path, 'wb') as f:
    f.write(tflite_model)
    print(f"\nğŸ’¾ TFLite ëª¨ë¸ ì €ì¥ ì™„ë£Œ: {tflite_path}")

tflite_size = len(tflite_model) / (1024 * 1024)

print(f"\nâœ… ë³€í™˜ ì™„ë£Œ!")
print(f"   ğŸ’¾ ì €ì¥ ê²½ë¡œ: {tflite_path}")
print(f"   ğŸ“¦ TFLite ëª¨ë¸ í¬ê¸°: {tflite_size:.2f} MB")
print(f"   ğŸ“‰ í¬ê¸° ê°ì†Œ: {(1 - tflite_size / keras_size) * 100:.1f}%")

# ============================================================================
# ğŸ§ª 8. TFLite ëª¨ë¸ í…ŒìŠ¤íŠ¸
# ============================================================================

print_section("TFLite ëª¨ë¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸", "ğŸ§ª")

# TFLite ì¸í„°í”„ë¦¬í„° ë¡œë“œ
interpreter = tf.lite.Interpreter(model_path=tflite_path)
interpreter.allocate_tensors()

input_details = interpreter.get_input_details()
output_details = interpreter.get_output_details()

print(f"ğŸ“¥ ì…ë ¥ ì •ë³´:")
print(f"   Shape: {input_details[0]['shape']}")
print(f"   Type: {input_details[0]['dtype']}")
print(f"ğŸ“¤ ì¶œë ¥ ì •ë³´:")
print(f"   Shape: {output_details[0]['shape']}")
print(f"   Type: {output_details[0]['dtype']}")

monitor = AdvancedResourceMonitor()

# ì›Œë°ì—…
print("\nâ³ ì›Œë°ì—… ì¤‘...")
for i in range(10):
    interpreter.set_tensor(input_details[0]['index'], x_test_normalized[i:i+1])
    interpreter.invoke()

# í…ŒìŠ¤íŠ¸ ì‹œì‘
print("â³ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘... (10,000ê°œ ì´ë¯¸ì§€)")
with tf.device('/CPU:0'):
    start_time = time.time()
    monitor.start()

    predictions_tflite = []
    for i in range(len(x_test_normalized)):
        interpreter.set_tensor(input_details[0]['index'], x_test_normalized[i:i+1])
        interpreter.invoke()
        output = interpreter.get_tensor(output_details[0]['index'])
        predictions_tflite.append(output[0])

        if (i + 1) % 1000 == 0:
            print(f"   ì²˜ë¦¬ ì™„ë£Œ: {i + 1}/{len(x_test_normalized)}")

    end_time = time.time()
    results = monitor.stop()

# ê²°ê³¼ ê³„ì‚°
predictions_tflite = np.array(predictions_tflite)
predicted_labels_tflite = np.argmax(predictions_tflite, axis=1)
accuracy_tflite = np.mean(predicted_labels_tflite == true_labels)
inference_time_tflite = end_time - start_time
avg_time_per_image_tflite = inference_time_tflite / len(x_test_normalized) * 1000

# # í´ë˜ìŠ¤ë³„ ì •í™•ë„
# print("\nğŸ“Š í´ë˜ìŠ¤ë³„ ì •í™•ë„ (TFLite):")
# for cls_idx in range(10):
#     cls_mask = true_labels == cls_idx
#     cls_accuracy = np.mean(predicted_labels_tflite[cls_mask] == true_labels[cls_mask])
#     print(f"   {class_names[cls_idx]:<12}: {cls_accuracy * 100:.2f}%")

# # í˜¼ë™ í–‰ë ¬
# cm_tflite = confusion_matrix(true_labels, predicted_labels_tflite)

print("\nâœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
print(f"\n{'='*50}")
print(f"ğŸ“Š TFLite ëª¨ë¸ ì„±ëŠ¥ ê²°ê³¼")
print(f"{'='*50}")
print(f"ğŸ¯ ì „ì²´ ì •í™•ë„:         {accuracy_tflite * 100:.2f}%")
print(f"â±ï¸  ì´ ì¶”ë¡  ì‹œê°„:         {inference_time_tflite:.3f}ì´ˆ")
print(f"â±ï¸  ì´ ì¶”ë¡  ì‹œê°„:         {results['inference_time_sec']:.3f}ì´ˆ")
print(f"âš¡ ì´ë¯¸ì§€ë‹¹ í‰ê·  ì‹œê°„:    {avg_time_per_image_tflite:.2f}ms")
print(f"ğŸ’» CPU ì‚¬ìš©ëŸ‰:           {results['avg_cpu_percent']:.1f}%")
print(f"ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:        {results['ram_mb']:.1f}MB")
print(f"{'='*50}")

print_results(results, len(x_test_normalized))

tflite_results = {
    'accuracy': accuracy_tflite,
    'inference_time': inference_time_tflite,
    'avg_time_per_image': avg_time_per_image_tflite,
    'cpu_percent': results['avg_cpu_percent'],
    'memory_mb': results['ram_mb'],
    'size_mb': tflite_size
}

# if monitor.has_gpu:
#     print(f"ğŸ® GPU ë©”ëª¨ë¦¬:           {end_stats['gpu_memory_mb']:.1f}MB")

# keras_results['gpu_memory_mb']
# tflite_results['gpu_memory_mb'] = end_stats['gpu_memory_mb']

# print(f"{tflite_results['gpu_memory_mb']:.1f} MB   {(1-tflite_results['gpu_memory_mb']/keras_results['gpu_memory_mb'])*100:.1f}% â¬‡ï¸")
print(f"{'ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰':<25} {keras_results['memory_mb']:>12.1f} MB   {tflite_results['memory_mb']:>12.1f} MB {(1-tflite_results['memory_mb']/keras_results['memory_mb'])*100:.1f}% â¬‡ï¸")

# ============================================================================
# ğŸ“ˆ 9. ìµœì¢… ë¹„êµ ë¶„ì„
# ============================================================================

print_section("ìµœì¢… ë¹„êµ ë¶„ì„", "ğŸ“ˆ")

# ë¹„êµ í…Œì´ë¸” ì¶œë ¥
print(f"\n{'ë©”íŠ¸ë¦­':<25} {'Keras ëª¨ë¸':<20} {'TFLite ëª¨ë¸':<20} {'ë³€í™”ìœ¨':<15}")
print("="*80)
print(f"{'ğŸ“¦ ëª¨ë¸ í¬ê¸°':<25} {keras_results['size_mb']:>12.2f} MB   {tflite_results['size_mb']:>12.2f} MB   {(1-tflite_results['size_mb']/keras_results['size_mb'])*100:>8.1f}% â¬‡ï¸")
print(f"{'ğŸ¯ ì •í™•ë„':<25} {keras_results['accuracy']*100:>12.2f}%    {tflite_results['accuracy']*100:>12.2f}%    {(tflite_results['accuracy']-keras_results['accuracy'])*100:>8.2f}%p")
print(f"{'âš¡ ì´ë¯¸ì§€ë‹¹ ì¶”ë¡ ì‹œê°„':<25} {keras_results['avg_time_per_image']:>12.2f} ms   {tflite_results['avg_time_per_image']:>12.2f} ms   ", end="")

speed_change = (keras_results['avg_time_per_image'] - tflite_results['avg_time_per_image']) / keras_results['avg_time_per_image'] * 100
if speed_change > 0:
    print(f"{speed_change:>8.1f}% â¬‡ï¸")
else:
    print(f"{abs(speed_change):>8.1f}% â¬†ï¸")

print(f"{'ğŸ’» CPU ì‚¬ìš©ëŸ‰':<25} {keras_results['cpu_percent']:>12.1f}%    {tflite_results['cpu_percent']:>12.1f}%")
print(f"{'ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰':<25} {keras_results['memory_mb']:>12.1f} MB   {tflite_results['memory_mb']:>12.1f} MB")
print("="*80)

# # ì‹œê°í™”
# fig = plt.figure(figsize=(16, 12))
# gs = fig.add_gridspec(3, 2, hspace=0.3, wspace=0.3)
#
# # 1. ëª¨ë¸ í¬ê¸° ë¹„êµ
# ax1 = fig.add_subplot(gs[0, 0])
# bars = ax1.bar(['Keras', 'TFLite'], [keras_results['size_mb'], tflite_results['size_mb']],
#                color=['#4285F4', '#34A853'])
# ax1.set_ylabel('í¬ê¸° (MB)', fontsize=12)
# ax1.set_title('ğŸ“¦ ëª¨ë¸ í¬ê¸° ë¹„êµ', fontsize=14, fontweight='bold')
# ax1.grid(axis='y', alpha=0.3)
# for i, v in enumerate([keras_results['size_mb'], tflite_results['size_mb']]):
#     ax1.text(i, v + 1, f'{v:.2f}MB', ha='center', fontweight='bold')

# # 2. ì •í™•ë„ ë¹„êµ
# ax2 = fig.add_subplot(gs[0, 1])
# bars = ax2.bar(['Keras', 'TFLite'], [keras_results['accuracy']*100, tflite_results['accuracy']*100],
#                color=['#4285F4', '#34A853'])
# ax2.set_ylabel('ì •í™•ë„ (%)', fontsize=12)
# ax2.set_title('ğŸ¯ ì •í™•ë„ ë¹„êµ', fontsize=14, fontweight='bold')
# ax2.set_ylim([0, 100])
# ax2.grid(axis='y', alpha=0.3)
# for i, v in enumerate([keras_results['accuracy']*100, tflite_results['accuracy']*100]):
#     ax2.text(i, v + 2, f'{v:.2f}%', ha='center', fontweight='bold')

# # 3. ì¶”ë¡  ì‹œê°„ ë¹„êµ
# ax3 = fig.add_subplot(gs[1, 0])
# bars = ax3.bar(['Keras', 'TFLite'], [keras_results['avg_time_per_image'], tflite_results['avg_time_per_image']],
#                color=['#4285F4', '#34A853'])
# ax3.set_ylabel('ì‹œê°„ (ms)', fontsize=12)
# ax3.set_title('âš¡ ì´ë¯¸ì§€ë‹¹ ì¶”ë¡  ì‹œê°„', fontsize=14, fontweight='bold')
# ax3.grid(axis='y', alpha=0.3)
# for i, v in enumerate([keras_results['avg_time_per_image'], tflite_results['avg_time_per_image']]):
#     ax3.text(i, v * 1.05, f'{v:.2f}ms', ha='center', fontweight='bold')

# # 4. í´ë˜ìŠ¤ë³„ ì •í™•ë„ ë¹„êµ
# ax4 = fig.add_subplot(gs[1, 1])
# class_accuracies_keras = []
# class_accuracies_tflite = []
# for cls_idx in range(10):
#     cls_mask = true_labels == cls_idx
#     class_accuracies_keras.append(np.mean(predicted_labels[cls_mask] == true_labels[cls_mask]) * 100)
#     class_accuracies_tflite.append(np.mean(predicted_labels_tflite[cls_mask] == true_labels[cls_mask]) * 100)

# x = np.arange(len(class_names))
# width = 0.35
# ax4.bar(x - width/2, class_accuracies_keras, width, label='Keras', color='#4285F4')
# ax4.bar(x + width/2, class_accuracies_tflite, width, label='TFLite', color='#34A853')
# ax4.set_ylabel('ì •í™•ë„ (%)', fontsize=12)
# ax4.set_title('ğŸ“Š í´ë˜ìŠ¤ë³„ ì •í™•ë„ ë¹„êµ', fontsize=14, fontweight='bold')
# ax4.set_xticks(x)
# ax4.set_xticklabels(class_names, rotation=45, ha='right')
# ax4.legend()
# ax4.grid(axis='y', alpha=0.3)

# # 5. í˜¼ë™ í–‰ë ¬ (Keras)
# ax5 = fig.add_subplot(gs[2, 0])
# im1 = ax5.imshow(cm, cmap='Blues', aspect='auto')
# ax5.set_xticks(range(10))
# ax5.set_yticks(range(10))
# ax5.set_xticklabels(class_names, rotation=45, ha='right', fontsize=9)
# ax5.set_yticklabels(class_names, fontsize=9)
# ax5.set_xlabel('ì˜ˆì¸¡', fontsize=12)
# ax5.set_ylabel('ì‹¤ì œ', fontsize=12)
# ax5.set_title('ğŸ“Š í˜¼ë™ í–‰ë ¬ (Keras)', fontsize=14, fontweight='bold')
# plt.colorbar(im1, ax=ax5)

# # 6. í˜¼ë™ í–‰ë ¬ (TFLite)
# ax6 = fig.add_subplot(gs[2, 1])
# im2 = ax6.imshow(cm_tflite, cmap='Blues', aspect='auto')
# ax6.set_xticks(range(10))
# ax6.set_yticks(range(10))
# ax6.set_xticklabels(class_names, rotation=45, ha='right', fontsize=9)
# ax6.set_yticklabels(class_names, fontsize=9)
# ax6.set_xlabel('ì˜ˆì¸¡', fontsize=12)
# ax6.set_ylabel('ì‹¤ì œ', fontsize=12)
# ax6.set_title('ğŸ“Š í˜¼ë™ í–‰ë ¬ (TFLite)', fontsize=14, fontweight='bold')
# plt.colorbar(im2, ax=ax6)

# plt.show()

# ìµœì¢… ìš”ì•½
print("\n" + "="*80)
print("ğŸ‰ TFLite ìµœì í™” íš¨ê³¼ ìš”ì•½")
print("="*80)
size_reduction = (1 - tflite_results['size_mb'] / keras_results['size_mb']) * 100
print(f"âœ… ëª¨ë¸ í¬ê¸° {size_reduction:.1f}% ê°ì†Œ ({keras_results['size_mb']:.2f}MB â†’ {tflite_results['size_mb']:.2f}MB)")

if speed_change > 0:
    print(f"âœ… ì¶”ë¡  ì†ë„ {speed_change:.1f}% í–¥ìƒ")
else:
    print(f"âš ï¸  ì¶”ë¡  ì†ë„ {abs(speed_change):.1f}% ê°ì†Œ (ë‹¨ì¼ ì´ë¯¸ì§€ ì¶”ë¡  ì‹œ ì¼ë°˜ì )")

acc_change = (tflite_results['accuracy'] - keras_results['accuracy']) * 100
if abs(acc_change) < 1:
    print(f"âœ… ì •í™•ë„ ê±°ì˜ ë™ì¼ ({acc_change:+.2f}%p ì°¨ì´)")
else:
    print(f"âš ï¸  ì •í™•ë„ {acc_change:+.2f}%p ë³€í™”")

print("="*80)
print("\nğŸ’¡ ëª¨ë¸ ì •ë³´:")
print(f"   ğŸ“Œ ëª¨ë¸: keras-io/supervised-contrastive-learning-cifar10")
print(f"   ğŸ—ï¸ ì•„í‚¤í…ì²˜: ResNet50V2 + Supervised Contrastive Learning")
print(f"   ğŸ“ ì…ë ¥ í¬ê¸°: 32x32x3 (CIFAR-10 í‘œì¤€)")
print(f"   ğŸ¯ ì¶œë ¥: 10ê°œ í´ë˜ìŠ¤ (softmax)")
print(f"   ğŸ“Š í•™ìŠµ ë°©ë²•: 2ë‹¨ê³„ í•™ìŠµ (Contrastive + Classification)")
print("\nğŸŠ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")